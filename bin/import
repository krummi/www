#!/usr/bin/env node

var Strava = require('../lib/strava');
var models = require('../lib/models');
var log = require('../lib/helpers/logger');
var _ = require('lodash');

var Activity = models.Activity;

Activity.findOne({
  order: [ [ 'startTime', 'DESC' ] ]
})
.then(function (activity) {
  var after;
  if (activity !== null) {
    after = activity.startTime;
    log.info('activity not null: ', after);
  }

  var strava = new Strava({
    accessToken: 'f2877b070e0172315d80bdcd21f7acd028f08851',
    updatedAt: after
  });

  strava.fetch(function (err, items) {

    if (err) {
      log.error({ err: err }, 'err hit when importing from Strava...');
    }

    Activity.bulkCreate(items)
    .then(function (items) {
      log.info('successfully imported %d items from Strava', items.length);
    })
    .catch(function (err) {
      log.error({ err: err }, 'error when inserting items from Strava.');
    });

  });

})
.catch(function (err) {
  log.error({ err: err }, 'err hit when fetching activity');
});
