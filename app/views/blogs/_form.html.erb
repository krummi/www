<%= form_for @blog, html: { id: 'blog-form' } do |f| %>
  <div class="field">
    <%= f.text_field :title, class: 'form-control input-lg', placeholder: 'The title of the blog' %>
  </div>
  <div style="margin-top: 13px;">
    <div id="epiceditor"></div>
    <%= f.text_area :body_md, id: "markdown-contents", style: 'display: none;' %>
    <%= f.text_area :body_html, id: "html-contents", style: 'display: none;' %>
  </div>
  <div style="margin-top: 13px;">
    <div style="font-weight: bold; margin-bottom: 5px;">Tags</div>
    <input type="text" name="tags" id="tags" value="<%= @blog.tag_list %>" />
  </div>
  <% if @blog.is_published %>
    <div style="margin-top: 13px;">
      <%= f.label :published_at %><br>
      <%= f.datetime_select :published_at %>
    </div>
  <% end %>
  <div style="margin: 13px 0; border-top: solid 1px #ccc; padding-top: 13px;">
    <div style="float: left;">
      <% if @blog.is_published %>
        <button type="button" class="btn btn-warning" id="toggle-publish">Unpublish</button>
      <% else %>
        <button type="button" class="btn btn-primary" id="toggle-publish"><i class="fa fa-upload"></i> Publish</button>
      <% end %>
      <button type="button" class="btn btn-default" id="save-and-close">Save &amp; Close</button>
    </div>
    <div style="float: right;">
      <span id="save-state" style="margin-right: 5px; font-size: 0.9em; display: none;">Saving...</span>
      <%= link_to '<i class="fa fa-trash-o"></i> Delete'.html_safe, @blog, method: :delete, data: { confirm: 'Are you sure you want to discard this blog?' }, class: 'btn btn-danger' %>
    </div>
    <div class="clearfix"></div>
  </div>
<% end %>

<script type="text/javascript">
$(function() {
  $('#tags').tagsinput({ 
    tagClass: function(item) { 
      return 'label label-primary';
    }
  });
  $('#tags').tagsinput('input').typeahead({
    local: ['timtrueman', 'JakeHarding', 'vskarich']
  });

  $('#blog_title').focusout(function() {
    console.log('focus out!');  
  })

  kweb.currentBlogUrl = '<%= blog_path(@blog) %>.json';
  kweb.currentBlogPublishUrl = '<%= blog_path(@blog) %>/publish.json'
  kweb.setupEditor();
  kweb.setupAutomaticSaving();

  $('#toggle-publish').click(function(e)Â {
    kweb.save(function() {
      kweb.togglePublish(function() {
        // TODO: lol @ this.
        window.location.reload();
      });
    })
  });
  $('#save-and-close').click(function(e) {
    kweb.save(function() {
      window.location.href = '<%= blogs_path %>';
    });
  });
});
</script>